<ion-content [fullscreen]="true" class="bg-black">
    <!-- Top Bar: Close + Live Indicator + Viewers -->
    <div
        class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between p-4 bg-gradient-to-b from-black/80 to-transparent">
        <button (click)="endLive()"
            class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center active:scale-90 transition-transform">
            <ion-icon name="close-outline" class="text-white text-2xl"></ion-icon>
        </button>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 bg-[#fe2c55] px-3 py-1.5 rounded-full animate-pulse">
                <div class="w-2 h-2 bg-white rounded-full"></div>
                <span class="text-white text-xs font-black">LIVE</span>
                <span class="text-white/80 text-xs font-bold">{{formatTime(elapsedTime)}}</span>
            </div>

            <div class="flex items-center gap-1 bg-black/40 px-3 py-1.5 rounded-full">
                <ion-icon name="people" class="text-white text-sm"></ion-icon>
                <span class="text-white text-xs font-bold">{{viewerCount}}</span>
            </div>
        </div>

        <button class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
            <ion-icon name="settings" class="text-white text-xl"></ion-icon>
        </button>
    </div>

    <!-- Video Container (Split Screen Handler) -->
    <div class="absolute inset-0 flex bg-black">
        <!-- Local Stream -->
        <div [class]="isPkMode ? 'w-1/2 h-full border-r border-white/10' : 'w-full h-full'">
            <video #localVideo autoplay muted playsinline class="w-full h-full object-cover"></video>

            <!-- PK You Label -->
            <div *ngIf="isPkMode"
                class="absolute top-24 left-4 bg-blue-500/80 px-2 py-0.5 rounded text-[10px] font-bold text-white z-10">
                YOU
            </div>
        </div>

        <!-- Remote PK Stream -->
        <div *ngIf="isPkMode" class="w-1/2 h-full relative">
            <video #pkVideo autoplay playsinline class="w-full h-full object-cover"></video>

            <!-- PK Opponent Label -->
            <div
                class="absolute top-24 right-4 bg-red-500/80 px-2 py-0.5 rounded text-[10px] font-bold text-white z-10">
                OPPONENT
            </div>
        </div>
    </div>

    <!-- VS Animation Overlay -->
    <div *ngIf="isPkMode" class="fixed inset-0 pointer-events-none flex items-center justify-center z-30">
        <img src="assets/icon/vs.png" class="w-24 h-24 animate-bounce drop-shadow-[0_0_15px_rgba(255,0,0,0.8)]"
            onerror="this.style.display='none'">
    </div>

    <!-- Comments Overlay -->
    <div class="fixed bottom-24 left-0 right-0 z-40 px-4 max-h-48 overflow-hidden pointer-events-none">
        <!-- ... existing comments code ... -->
        <div *ngFor="let c of comments"
            class="flex items-center gap-2 bg-black/40 backdrop-blur-sm w-fit px-3 py-1.5 rounded-full mb-2 animate-slide-up">
            <img [src]="c.senderAvatar || 'https://i.pravatar.cc/30'" class="w-6 h-6 rounded-full object-cover">
            <span class="text-white font-bold text-xs">{{c.senderName}}</span>
            <span class="text-white/80 text-xs">{{c.message}}</span>
        </div>
    </div>

    <!-- Gift Notifications -->
    <div class="fixed top-1/3 left-4 z-50 pointer-events-none">
        <!-- ... existing gifts code ... -->
        <div *ngFor="let g of gifts.slice(0, 3)"
            class="flex items-center gap-2 bg-gradient-to-r from-pink-500/80 to-purple-500/80 backdrop-blur-sm px-4 py-2 rounded-full mb-2 animate-slide-right">
            <span class="text-2xl">{{g.giftIcon}}</span>
            <div>
                <span class="text-white font-bold text-xs">{{g.senderName}}</span>
                <span class="text-white/80 text-xs"> sent {{g.giftName}}</span>
            </div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="fixed bottom-0 left-0 right-0 z-50 bg-gradient-to-t from-black to-transparent p-4 pb-8">
        <div class="flex items-center justify-center gap-6">
            <button class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center">
                <ion-icon name="chatbubble" class="text-white text-2xl"></ion-icon>
            </button>

            <!-- PK Button -->
            <button (click)="openPkModal()" *ngIf="!isPkMode"
                class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center absolute -top-16 right-4 shadow-lg active:scale-95 transition-transform">
                <ion-icon name="flash" class="text-white text-xl"></ion-icon>
            </button>

            <button (click)="endLive()"
                class="px-8 py-3 bg-[#fe2c55] rounded-full shadow-lg active:scale-95 transition-transform">
                <span class="text-white font-black text-sm">End Live</span>
            </button>

            <button class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center">
                <ion-icon name="gift" class="text-white text-2xl"></ion-icon>
            </button>
        </div>
    </div>

    <!-- PK Invite Modal -->
    <ion-modal [isOpen]="isPkModalOpen" (didDismiss)="closePkModal()" [initialBreakpoint]="0.5"
        [breakpoints]="[0, 0.5]">
        <ng-template>
            <div class="bg-slate-900 h-full p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-white font-bold text-lg">Battle Invitations ⚔️</h2>
                    <ion-button fill="clear" (click)="closePkModal()">
                        <ion-icon name="close-outline" class="text-white"></ion-icon>
                    </ion-button>
                </div>

                <ion-list class="bg-transparent">
                    <ion-item *ngFor="let s of activeStreamers" class="bg-transparent border-b border-white/10"
                        lines="none">
                        <ion-avatar slot="start">
                            <img [src]="s.host_avatar || 'https://i.pravatar.cc/150'" />
                        </ion-avatar>
                        <ion-label class="text-white">
                            <h3 class="font-bold">{{s.host_name || 'Streamer'}}</h3>
                            <p class="text-white/60 text-xs">Live</p>
                        </ion-label>
                        <ion-button slot="end" size="small" color="primary" (click)="sendPkInvite(s)">
                            Invite
                        </ion-button>
                    </ion-item>
                    <div *ngIf="activeStreamers.length === 0" class="text-white/50 text-center mt-8">
                        No other broadcasters online.
                    </div>
                </ion-list>
            </div>
        </ng-template>
    </ion-modal>
</ion-content>